#include <fcntl.h>
#include <stdio.h>
#include <unistd.h>
#include <linux/input.h>

#define DEVICES "/dev/input/by-id/"

//static const int hw2kc[] = { 29,42,56,125,97,54,100,126,30,48,46,32,18,33,34,35,23,36,37,38,50,49,24,25,16,19,31,20,22,47,17,45,21,44,0x2,0x3,0x4,0x5,0x6,0x7,0x8,0x9,10,11,28,0x1,14,15,57,12,13,26,27,43,43,39,40,41,51,52,53,58,59,60,61,62,63,64,65,66,67,68,87,88,99,70,119,110,102,104,111,107,109,106,105,108,103,69,98,55,74,78,96,79,80,81,75,76,77,71,72,73,82,83,86,127,116,117,183,184,185,186,187,188,189,190,191,192,193,194,134,138,130,132,128,129,131,137,133,135,136,113,115,114,240,240,240,121,240,89,93,124,92,94,95,240,240,240,122,123,90,91,85,240,240,240,240,240,240,240,111,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,179,180,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,111,240,240,240,240,240,240,240,29,42,56,125,97,54,100,126,164,166,165,163,161,115,114,113,150,158,159,128,136,177,178,176,142,152,173,140,240,240,240,240 };
static const int kc2hw[] = { 0x0,0x70029,0x7001e,0x7001f,0x70020,0x70021,0x70022,0x70023,0x70024,0x70025,0x70026,0x70027,0x7002d,0x7002e,0x7002a,0x7002b,0x70014,0x7001a,0x70008,0x70015,0x70017,0x7001c,0x70018,0x7000c,0x70012,0x70013,0x7002f,0x70030,0x70028,0x700e0,0x70004,0x70016,0x70007,0x70009,0x7000a,0x7000b,0x7000d,0x7000e,0x7000f,0x70033,0x70034,0x70035,0x700e1,0x70031,0x7001d,0x7001b,0x70006,0x70019,0x70005,0x70011,0x70010,0x70036,0x70037,0x70038,0x700e5,0x70055,0x700e2,0x7002c,0x70039,0x7003a,0x7003b,0x7003c,0x7003d,0x7003e,0x7003f,0x70040,0x70041,0x70042,0x70043,0x70053,0x70047,0x7005f,0x70060,0x70061,0x70056,0x7005c,0x7005d,0x7005e,0x70057,0x70059,0x7005a,0x7005b,0x70062,0x70063,0x0,0x70094,0x70064,0x70044,0x70045,0x70087,0x70092,0x70093,0x7008a,0x70088,0x7008b,0x7008c,0x70058,0x700e4,0x70054,0x70046,0x700e6,0x0,0x7004a,0x70052,0x7004b,0x70050,0x7004f,0x7004d,0x70051,0x7004e,0x70049,0x7004c,0x0,0x7007f,0x70081,0x70080,0x70066,0x70067,0x0,0x70048,0x0,0x70085,0x70090,0x70091,0x70089,0x700e3,0x700e7,0x70065,0x70078,0x70079,0x70076,0x7007a,0x70077,0x7007c,0x70074,0x7007d,0x7007e,0x7007b,0x70075,0x0,0x700fb };
static const int remap[] = {
	KEY_KP1, KEY_KP2, KEY_KP3,
	KEY_KP4, KEY_KP5, KEY_KP6,
	KEY_KP7, KEY_KP8, KEY_KP9,
	KEY_KP0, KEY_KPPLUS, KEY_KPMINUS
};

int main(void)
{
	setbuf(stdout, NULL);
	int naga, keyboard;
	do {
		naga = open(DEVICES "usb-Razer_Razer_Naga_Chroma-if02-event-kbd", O_RDONLY);
		keyboard = open(DEVICES "usb-t.m.k._HHKB_mod-event-kbd", O_WRONLY);
		sleep(1);
	} while(naga == -1 || keyboard == -1);

    ioctl(naga, EVIOCGRAB, 1);

    struct input_event ev[64] = { 0 };
    int size = sizeof(struct input_event);

    while (1){
        int rd = read(naga, ev, size * 64);
        int i = (rd == size*3);

		ev[i].code = remap[ev[i].code - 2];
        if(i == 1){
        	ev[0].value = kc2hw[ev[1].code];
		}

		if(write(keyboard, ev, rd) == -1){
			close(keyboard);
			keyboard = open(DEVICES "usb-t.m.k._HHKB_mod-event-kbd", O_WRONLY);
		}
    }
}
